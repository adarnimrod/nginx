---
# tasks file for ansible-role-nginx

- assert:
    that:
    - ansible_os_family in [ 'Debian', 'OpenBSD' ]

- name: apt install
  when: ansible_pkg_mgr == 'apt'
  apt:
    name: nginx-full
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: pkg install
  when: ansible_pkg_mgr == 'openbsd_pkg'
  openbsd_pkg:
    name: '{{ nginx_openbsd_pkg[ansible_distribution_release] }}'
    state: present

- name: Create configuration directories
  with_items:
  - /etc/nginx/sites-enabled
  - /etc/nginx/conf.d
  file:
    path: '{{ item }}'
    owner: root
    group: 0
    mode: 0o0755
    state: directory

- name: Include configuration directories
  with_items:
  - /etc/nginx/sites-enabled/*
  - /etc/nginx/conf.d/*.conf
  lineinfile:
    dest: /etc/nginx/nginx.conf
    line: '	include {{ item }};'
    insertafter: 'http {'
  notify:
  - Reload Nginx

- name: Disable default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify:
  - Reload Nginx

- name: Copy sites templates
  with_fileglob:
  - templates/nginx.sites-enabled/*
  template:
      src: '{{ item }}'
      dest: /etc/nginx/sites-enabled/
      owner: root
      group: 0
      mode: 0o0644
  notify:
  - Reload Nginx

- name: Copy configuration templates
  with_fileglob:
  - templates/nginx.conf.d/*
  template:
      src: '{{ item }}'
      dest: /etc/nginx/conf.d/
      owner: root
      group: 0
      mode: 0o0644
  notify:
  - Reload Nginx

- name: Enable service
  service:
      name: nginx
      state: running
      enabled: yes
